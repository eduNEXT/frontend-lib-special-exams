{"version":3,"file":"TimerProvider.js","names":["_react","_interopRequireWildcard","require","_reactRedux","_propTypes","_interopRequireDefault","_data","_events","_jsxRuntime","obj","__esModule","default","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","GRACE_PERIOD_SECS","POLL_INTERVAL","TIME_LIMIT_CRITICAL_PCT","TIME_LIMIT_LOW_PCT","LIMIT","TimerContext","exports","React","createContext","getFormattedRemainingTime","timeLeft","hours","Math","floor","minutes","seconds","TimerProvider","_ref","children","activeAttempt","attempt","exam","useSelector","state","specialExams","timeState","setTimeState","useState","lastSignal","useRef","dispatch","useDispatch","time_limit_mins","timeLimitMins","desktop_application_js_url","workerUrl","ping_interval","pingInterval","timer_ends","timerEnds","getTimeString","values","map","item","value","join","pollExam","useCallback","pollAttempt","exam_started_poll_url","processTimeLeft","secondsLeft","emit","signal","current","Emitter","criticalLowTime","lowTime","TIMER_LIMIT_REACHED","TIMER_REACHED_NULL","TIMER_IS_CRITICALLY_LOW","TIMER_IS_LOW","deadline","Date","useEffect","timerRef","timerTick","ticker","now","remainingTime","getTime","pingAttempt","killTimer","clearInterval","setTimeout","setInterval","jsx","Provider","propTypes","PropTypes","element","isRequired","_default"],"sources":["../../src/timer/TimerProvider.jsx"],"sourcesContent":["import React, {\n  useEffect, useState, useCallback, useRef,\n} from 'react';\nimport { useDispatch, useSelector } from 'react-redux';\nimport PropTypes from 'prop-types';\nimport { Emitter, pollAttempt, pingAttempt } from '../data';\nimport {\n  TIMER_IS_CRITICALLY_LOW,\n  TIMER_IS_LOW,\n  TIMER_LIMIT_REACHED,\n  TIMER_REACHED_NULL,\n} from './events';\n\n// Give an extra 5 seconds where the timer holds at 00:00 before page refreshes\nconst GRACE_PERIOD_SECS = 5;\nconst POLL_INTERVAL = 60;\nconst TIME_LIMIT_CRITICAL_PCT = 0.05;\nconst TIME_LIMIT_LOW_PCT = 0.2;\nconst LIMIT = GRACE_PERIOD_SECS ? 0 - GRACE_PERIOD_SECS : 0;\n\nexport const TimerContext = React.createContext({});\n\nconst getFormattedRemainingTime = (timeLeft) => ({\n  hours: Math.floor(timeLeft / (60 * 60)),\n  minutes: Math.floor((timeLeft / 60) % 60),\n  seconds: Math.floor(timeLeft % 60),\n});\n\nconst TimerProvider = ({\n  children,\n}) => {\n  const { activeAttempt: attempt, exam } = useSelector(state => state.specialExams);\n  const [timeState, setTimeState] = useState({});\n  const lastSignal = useRef(null);\n  const dispatch = useDispatch();\n  const { time_limit_mins: timeLimitMins } = exam;\n  const {\n    desktop_application_js_url: workerUrl,\n    ping_interval: pingInterval,\n    timer_ends: timerEnds,\n  } = attempt;\n\n  const getTimeString = () => Object.values(timeState).map(\n    item => {\n      // Do not show timer negative value.\n      // User will see 00:00:00 during grace period if any.\n      const value = item < 0 ? 0 : item;\n      return (value < 10 ? `0${value}` : value);\n    },\n  ).join(':');\n\n  const pollExam = useCallback(() => {\n    // Poll url may be null if this is an LTI exam.\n    dispatch(pollAttempt(attempt.exam_started_poll_url));\n  }, [attempt.exam_started_poll_url, dispatch]);\n\n  const processTimeLeft = useCallback((secondsLeft) => {\n    const emit = (signal) => {\n      // This prevents spamming.\n      if (lastSignal.current === signal) {\n        return;\n      }\n      Emitter.emit(signal);\n      lastSignal.current = signal;\n    };\n\n    const criticalLowTime = timeLimitMins * 60 * TIME_LIMIT_CRITICAL_PCT;\n    const lowTime = timeLimitMins * 60 * TIME_LIMIT_LOW_PCT;\n\n    if (secondsLeft <= LIMIT) {\n      emit(TIMER_LIMIT_REACHED);\n      return true; // Kill the timer.\n    }\n\n    if (secondsLeft <= 0) {\n      // Used to hide continue exam button on submit exam pages.\n      // Since TIME_LIMIT_REACHED is fired after the grace period we\n      // need to emit separate event when timer reaches 00:00\n      emit(TIMER_REACHED_NULL);\n      return false;\n    }\n\n    if (secondsLeft <= criticalLowTime) {\n      emit(TIMER_IS_CRITICALLY_LOW);\n      return false;\n    }\n\n    if (secondsLeft <= lowTime) {\n      emit(TIMER_IS_LOW);\n      return false;\n    }\n\n    return false;\n  }, [\n    timeLimitMins,\n  ]);\n\n  // Set deadline as a reference to timerEnds that updates when it changes\n  const deadline = useRef(new Date(timerEnds));\n  useEffect(() => {\n    deadline.current = new Date(timerEnds);\n  }, [timerEnds]);\n\n  useEffect(() => {\n    const timerRef = { current: true };\n    let timerTick = -1;\n\n    const ticker = () => {\n      timerTick++;\n      const now = Date.now();\n      const remainingTime = (deadline.current.getTime() - now) / 1000;\n      const secondsLeft = Math.floor(remainingTime);\n\n      setTimeState(getFormattedRemainingTime(secondsLeft));\n\n      // No polling during grace period.\n      if (timerTick % POLL_INTERVAL === 0 && secondsLeft >= 0) {\n        pollExam();\n      }\n\n      // If exam is proctored ping provider app.\n      if (workerUrl && timerTick % pingInterval === pingInterval / 2) {\n        dispatch(pingAttempt(pingInterval, workerUrl));\n      }\n\n      const killTimer = processTimeLeft(secondsLeft);\n      if (killTimer) {\n        clearInterval(timerRef.current);\n        timerRef.current = null;\n      }\n    };\n\n    // We delay the first ticker execution to give time for the emmiter\n    // subscribers to hook up, otherwise immediate emissions will miss their purpose.\n    setTimeout(() => {\n      ticker();\n\n      // If the timer handler is not true at this point, it means that it was stopped in the first run.\n      // So we don't need to start the timer.\n      if (timerRef.current === true) {\n        // After the first run, we start the ticker.\n        timerRef.current = setInterval(ticker, 1000);\n      }\n    });\n\n    return () => {\n      clearInterval(timerRef.current);\n      timerRef.current = null;\n    };\n  }, [\n    pingInterval,\n    workerUrl,\n    processTimeLeft,\n    pollExam,\n    dispatch,\n  ]);\n\n  return (\n    // eslint-disable-next-line react/jsx-no-constructed-context-values\n    <TimerContext.Provider value={{\n      timeState,\n      getTimeString,\n    }}\n    >\n      {children}\n    </TimerContext.Provider>\n  );\n};\n\nTimerProvider.propTypes = {\n  children: PropTypes.element.isRequired,\n};\nexport default TimerProvider;\n"],"mappings":"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"}